<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BSF Chicken Feeder Gantt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --background: #f1f4fb;
      --surface: #ffffff;
      --text: #1c2533;
      --muted: #5b6b86;
      --accent: #8c77f0;
      --grid-line: rgba(92, 107, 134, 0.18);
      --day-width: 28px;
      --row-height: 56px;
      --header-height: 54px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--background);
      color: var(--text);
      line-height: 1.5;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px 48px;
    }

    .page-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 24px;
      margin-bottom: 28px;
    }

    .page-header .hero h1 {
      margin: 0 0 4px;
      font-size: 2rem;
      font-weight: 700;
      color: var(--text);
    }

    .page-header .hero .date-range {
      margin: 0;
      font-size: 0.95rem;
      color: var(--muted);
      letter-spacing: 0.02em;
    }

    .project-dates {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .date-chip {
      background: var(--surface);
      padding: 12px 16px;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(28, 37, 51, 0.08);
      min-width: 140px;
    }

    .date-chip span {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .date-chip strong {
      display: block;
      font-size: 1rem;
      color: var(--text);
    }

    .legend {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 28px;
    }

    .legend-card {
      background: var(--surface);
      border-radius: 20px;
      padding: 20px 22px;
      box-shadow: 0 16px 40px rgba(28, 37, 51, 0.06);
    }

    .legend-card h2 {
      margin: 0 0 12px;
      font-size: 1.02rem;
      font-weight: 600;
      color: var(--text);
    }

    .legend-items {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .legend-avatar {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-weight: 600;
      font-size: 0.95rem;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4);
    }

    .legend-info {
      display: flex;
      flex-direction: column;
      line-height: 1.3;
    }

    .legend-info span:first-child {
      font-weight: 600;
      color: var(--text);
    }

    .legend-info span:last-child {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .legend-items--categories .legend-item {
      align-items: center;
    }

    .legend-swatch {
      width: 18px;
      height: 18px;
      border-radius: 6px;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
    }

    .glance-list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .glance-list li {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .glance-list strong {
      color: var(--text);
      font-weight: 600;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      margin-bottom: 26px;
    }

    .summary-panel {
      flex: 1 1 320px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 14px;
    }

    .metric-card {
      background: var(--surface);
      border-radius: 18px;
      padding: 16px 18px;
      box-shadow: 0 14px 30px rgba(28, 37, 51, 0.06);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .metric-card span {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .metric-card strong {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
    }

    .controls-actions {
      flex: 1 1 220px;
      display: flex;
      align-items: stretch;
      gap: 14px;
      min-width: 260px;
    }

    .control {
      flex: 1 1 0;
      background: var(--surface);
      border-radius: 18px;
      padding: 14px 16px;
      box-shadow: 0 14px 30px rgba(28, 37, 51, 0.06);
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .control input[type="range"] {
      width: 100%;
    }

    .control input[type="date"] {
      border: 1px solid rgba(92, 107, 134, 0.25);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 0.9rem;
      color: var(--text);
    }

    .control-button {
      flex: 0 0 auto;
      align-self: center;
      border: none;
      background: var(--accent);
      color: #fff;
      padding: 14px 18px;
      border-radius: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 12px 26px rgba(140, 119, 240, 0.25);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .control-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 38px rgba(140, 119, 240, 0.28);
    }

    .chart-section {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }

    .chart-wrapper {
      flex: 1 1 0;
      display: flex;
      background: var(--surface);
      border-radius: 24px;
      box-shadow: 0 18px 40px rgba(28, 37, 51, 0.08);
      overflow: hidden;
      min-width: 0;
    }

    .label-column {
      width: 260px;
      border-right: 1px solid rgba(92, 107, 134, 0.1);
      background: #f7f9fd;
      display: flex;
      flex-direction: column;
      padding-top: var(--header-height);
    }

    .label-header {
      position: sticky;
      top: 0;
      background: #f7f9fd;
      z-index: 2;
      padding: 18px 20px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      border-bottom: 1px solid rgba(92, 107, 134, 0.15);
    }

    .label-rows {
      display: flex;
      flex-direction: column;
    }

    .label-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 20px;
      min-height: var(--row-height);
      border-bottom: 1px solid rgba(92, 107, 134, 0.05);
      transition: background 0.2s ease;
    }

    .label-row .label-index {
      font-weight: 600;
      font-size: 0.8rem;
      color: rgba(28, 37, 51, 0.55);
    }

    .label-row .label-name {
      flex: 1 1 auto;
      font-weight: 500;
      color: var(--text);
    }

    .label-row .label-duration {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .label-row.active,
    .label-row.hovered {
      background: rgba(140, 119, 240, 0.12);
    }

    .label-row.is-parent .label-name {
      font-weight: 600;
    }

    .chart-scroller {
      flex: 1 1 0;
      overflow-x: auto;
      overflow-y: hidden;
      position: relative;
      cursor: grab;
    }

    .chart-scroller.is-dragging {
      cursor: grabbing;
    }

    .chart-scroller.is-dragging * {
      user-select: none;
    }

    .chart-area {
      position: relative;
      min-height: 420px;
      padding-bottom: 24px;
      background: linear-gradient(180deg, rgba(247, 249, 253, 0.9), rgba(255, 255, 255, 0.85));
    }

    .chart-area .empty-state {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 24px 28px;
      border-radius: 16px;
      background: rgba(140, 119, 240, 0.08);
      color: var(--muted);
      font-size: 0.95rem;
      text-align: center;
      max-width: 320px;
      box-shadow: 0 12px 32px rgba(28, 37, 51, 0.08);
    }

    .timeline-header {
      position: sticky;
      top: 0;
      left: 0;
      height: var(--header-height);
      background: var(--surface);
      border-bottom: 1px solid rgba(92, 107, 134, 0.12);
      z-index: 3;
      display: flex;
      align-items: center;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .timeline-label {
      position: absolute;
      top: 16px;
      font-weight: 600;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(140, 119, 240, 0.12);
      color: var(--text);
      transform: translateX(-50%);
      white-space: nowrap;
    }

    .gantt-grid {
      position: absolute;
      top: var(--header-height);
      left: 0;
      right: 0;
      bottom: 24px;
      background-image:
        linear-gradient(to right, var(--grid-line) 1px, transparent 0),
        linear-gradient(to bottom, rgba(92, 107, 134, 0.08) 1px, transparent 0);
      background-size: var(--day-width) 100%, 100% var(--row-height);
      pointer-events: none;
      z-index: 0;
    }

    .tasks-layer,
    .milestone-layer,
    .dependency-layer,
    .today-line {
      position: absolute;
      left: 0;
      top: 0;
    }

    .tasks-layer {
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 2;
    }

    .task-bar {
      position: absolute;
      height: 28px;
      border-radius: 14px;
      box-shadow: 0 8px 20px rgba(28, 37, 51, 0.18);
      overflow: hidden;
      display: flex;
      align-items: center;
      padding: 0 14px 0 38px;
      color: #fff;
      font-size: 0.82rem;
      font-weight: 600;
      pointer-events: auto;
      cursor: pointer;
      backdrop-filter: blur(2px);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
      isolation: isolate;
      animation: float-in 600ms ease both;
    }

    .task-bar::before {
      content: "";
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
    }

    .task-bar .task-bar__content {
      position: relative;
      z-index: 2;
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      justify-content: space-between;
    }

    .task-chip {
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      opacity: 0.75;
    }

    .task-title {
      flex: 1 1 auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .task-progress-label {
      font-size: 0.78rem;
      opacity: 0.85;
    }

    .task-bar .progress-fill {
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.05));
      transform-origin: left center;
      z-index: 1;
      mix-blend-mode: screen;
      pointer-events: none;
    }

    .task-bar .resource-badges {
      position: absolute;
      right: 12px;
      bottom: -16px;
      display: flex;
      gap: 6px;
      z-index: 3;
    }

    .resource-badge {
      width: 24px;
      height: 24px;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: #fff;
      box-shadow: 0 6px 12px rgba(12, 32, 66, 0.28);
    }

    .task-bar:hover {
      transform: translateY(-3px);
      box-shadow: 0 14px 28px rgba(28, 37, 51, 0.26);
    }

    .task-bar.is-hover {
      transform: translateY(-3px);
      box-shadow: 0 14px 28px rgba(28, 37, 51, 0.26);
    }

    .task-bar.is-active {
      outline: 2px solid #fff;
      box-shadow: 0 18px 32px rgba(140, 119, 240, 0.4);
    }

    .task-bar.is-pinned {
      transform: translateY(-2px);
      box-shadow: 0 20px 36px rgba(140, 119, 240, 0.35);
    }

    .task-bar.task-bar--group {
      height: 32px;
      border-radius: 16px;
      padding-left: 44px;
      letter-spacing: 0.02em;
    }

    .task-bar.task-bar--complete {
      filter: saturate(0.8);
    }

    .task-bar.task-bar--idle {
      filter: saturate(0.7) brightness(1.02);
    }

    @keyframes float-in {
      from {
        opacity: 0;
        transform: translateY(12px) scaleX(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scaleX(1);
      }
    }

    .dependency-layer {
      pointer-events: none;
      fill: none;
      stroke-width: 2;
      z-index: 1;
    }

    .dependency-layer path {
      stroke: rgba(50, 64, 89, 0.55);
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .dependency-layer text.dependency-offset {
      font-size: 0.65rem;
      fill: rgba(28, 37, 51, 0.65);
      text-anchor: middle;
      dominant-baseline: central;
    }

    .dependency-layer path.highlighted {
      stroke: rgba(140, 119, 240, 0.9);
      stroke-width: 2.5;
    }

    .milestone-layer {
      pointer-events: none;
      z-index: 3;
    }

    .milestone {
      position: absolute;
      width: 16px;
      height: 16px;
      border-radius: 4px;
      transform: translate(-50%, -50%) rotate(45deg);
      background: #ff9f43;
      box-shadow: 0 10px 24px rgba(255, 159, 67, 0.36);
      border: 2px solid #fff;
    }

    .milestone-label {
      position: absolute;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(28, 37, 51, 0.85);
      color: #fff;
      font-size: 0.72rem;
      padding: 4px 8px;
      border-radius: 10px;
      white-space: nowrap;
    }

    .today-line {
      pointer-events: none;
      top: var(--header-height);
      bottom: 24px;
      width: 2px;
      background: linear-gradient(180deg, rgba(255, 99, 132, 0), rgba(255, 99, 132, 0.65), rgba(255, 99, 132, 0));
      z-index: 4;
      display: none;
    }

    .today-line span {
      position: absolute;
      top: -26px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 99, 132, 0.85);
      color: #fff;
      font-size: 0.72rem;
      padding: 4px 8px;
      border-radius: 10px;
      white-space: nowrap;
    }

    .details-panel {
      width: 300px;
      background: var(--surface);
      border-radius: 24px;
      box-shadow: 0 18px 40px rgba(28, 37, 51, 0.08);
      padding: 24px 24px 28px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      position: sticky;
      top: 24px;
    }

    .details-panel.is-pinned {
      box-shadow: 0 22px 44px rgba(140, 119, 240, 0.24);
    }

    .details-header h2 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text);
    }

    .details-header p {
      margin: 6px 0 0;
      font-size: 0.88rem;
      color: var(--muted);
    }

    .details-body {
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .detail-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .detail-row dt {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .detail-row dd {
      margin: 0;
      font-size: 0.95rem;
      color: var(--text);
    }

    .resource-load h3 {
      margin: 0 0 10px;
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text);
    }

    .resource-bars {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .workload-row {
      display: grid;
      grid-template-columns: 70px 1fr auto;
      align-items: center;
      gap: 10px;
      font-size: 0.85rem;
    }

    .workload-label {
      font-weight: 600;
      color: var(--text);
    }

    .workload-bar {
      position: relative;
      height: 10px;
      border-radius: 999px;
      background: rgba(92, 107, 134, 0.15);
      overflow: hidden;
    }

    .workload-fill {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      border-radius: 999px;
    }

    .workload-value {
      font-variant-numeric: tabular-nums;
      color: var(--muted);
    }

    @media (max-width: 1180px) {
      .chart-section {
        flex-direction: column;
      }
      .details-panel {
        position: static;
        width: 100%;
        order: -1;
      }
    }

    @media (max-width: 960px) {
      .controls {
        flex-direction: column;
      }
      .controls-actions {
        flex-direction: column;
      }
      .chart-wrapper {
        flex-direction: column;
      }
      .label-column {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid rgba(92, 107, 134, 0.1);
      }
      .chart-scroller {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-header">
      <div class="hero">
        <h1>BSF Chicken Feeder</h1>
        <p class="date-range" id="projectDateRange"></p>
      </div>
      <div class="project-dates">
        <div class="date-chip">
          <span>Kickoff</span>
          <strong id="projectStart"></strong>
        </div>
        <div class="date-chip">
          <span>Wrap</span>
          <strong id="projectEnd"></strong>
        </div>
      </div>
    </header>

    <section class="legend">
      <div class="legend-card">
        <h2>Project Team</h2>
        <div class="legend-items" id="teamLegend"></div>
      </div>
      <div class="legend-card">
        <h2>Task Categories</h2>
        <div class="legend-items legend-items--categories" id="categoryLegend"></div>
      </div>
      <div class="legend-card">
        <h2>At a Glance</h2>
        <ul class="glance-list">
          <li>
            <span>Total Duration</span>
            <strong id="glanceDuration"></strong>
          </li>
          <li>
            <span>Dependencies</span>
            <strong id="glanceDependencies"></strong>
          </li>
          <li>
            <span>Timeline Coverage</span>
            <strong id="glanceWeeks"></strong>
          </li>
        </ul>
      </div>
    </section>

    <section class="controls">
      <div class="summary-panel">
        <div class="metric-card">
          <span>Total Tasks</span>
          <strong id="metricTasks"></strong>
        </div>
        <div class="metric-card">
          <span>Avg Progress</span>
          <strong id="metricProgress"></strong>
        </div>
        <div class="metric-card">
          <span>Schedule Status</span>
          <strong id="metricRemaining"></strong>
        </div>
        <div class="metric-card">
          <span>Active Resources</span>
          <strong id="metricResources"></strong>
        </div>
      </div>
      <div class="controls-actions">
        <label class="control">
          <span>Zoom</span>
          <input type="range" id="zoomControl" min="18" max="60" step="2" value="30">
        </label>
        <label class="control">
          <span>Jump to Date</span>
          <input type="date" id="dateNavigator">
        </label>
        <button type="button" class="control-button" id="resetView">Reset View</button>
      </div>
    </section>

    <section class="chart-section">
      <div class="chart-wrapper">
        <div class="label-column">
          <div class="label-header">Timeline</div>
          <div class="label-rows" id="labelColumn"></div>
        </div>
        <div class="chart-scroller">
          <div class="chart-area">
            <div class="timeline-header" id="timelineHeader"></div>
            <div class="gantt-grid" id="ganttGrid"></div>
            <div class="milestone-layer" id="milestoneLayer"></div>
            <div class="tasks-layer" id="tasksLayer"></div>
            <svg class="dependency-layer" id="dependencyLayer"></svg>
            <div class="today-line" id="todayLine"><span>Today</span></div>
          </div>
        </div>
      </div>
      <aside class="details-panel" id="detailsPanel">
        <div class="details-header">
          <h2 id="detailsTitle">Hover a task</h2>
          <p id="detailsSubtitle">Timeline, resources, and dependencies appear here.</p>
        </div>
        <dl class="details-body">
          <div class="detail-row">
            <dt>Schedule</dt>
            <dd id="detailDates">—</dd>
          </div>
          <div class="detail-row">
            <dt>Progress</dt>
            <dd id="detailProgress">—</dd>
          </div>
          <div class="detail-row">
            <dt>Resources</dt>
            <dd id="detailResources">—</dd>
          </div>
          <div class="detail-row">
            <dt>Dependencies</dt>
            <dd id="detailDependencies">—</dd>
          </div>
        </dl>
        <div class="resource-load">
          <h3>Resource Workload</h3>
          <div class="resource-bars" id="resourceWorkload"></div>
        </div>
      </aside>
    </section>
  </div>

  <script>
    const embeddedDataset = {"data":[{"TaskID":1,"TaskName":"BSF Chicken Feeder","StartDate":"2025-10-21T15:00:00.000Z","EndDate":"2025-12-04T01:00:00.000Z","Duration":44,"Predecessor":null,"resources":[],"Progress":1,"color":"301","info":"<p><br></p>","DurationUnit":"day","subtasks":[{"TaskID":2,"TaskName":"Finalize Design","StartDate":"2025-10-21T15:00:00.000Z","EndDate":"2025-10-24T00:00:00.000Z","Duration":3,"Predecessor":"","resources":[{"resourceId":"Guanghan","resourceName":"Guanghan","unit":100},{"resourceId":"Isaac","resourceName":"Isaac","unit":100},{"resourceId":"John","resourceName":"John","unit":100},{"resourceId":"Renee","resourceName":"Renee","unit":100}],"Progress":30,"color":"211","info":"<p><br></p>","DurationUnit":"day"},{"TaskID":3,"TaskName":"Materials List/BOM","StartDate":"2025-10-22T15:00:00.000Z","EndDate":"2025-10-24T00:00:00.000Z","Duration":2,"Predecessor":"2FS-2 days","resources":[{"resourceId":"Isaac","resourceName":"Isaac","unit":100}],"Progress":0,"color":"211","info":"<p><br></p>","DurationUnit":"day"},{"TaskID":4,"TaskName":"Gather Material","StartDate":"2025-10-24T15:00:00.000Z","EndDate":"2025-10-26T00:00:00.000Z","Duration":2,"Predecessor":"3FS","resources":[{"resourceId":"Guanghan","resourceName":"Guanghan","unit":100}],"Progress":0,"color":"211","info":"<p><br></p>","DurationUnit":"day"},{"TaskID":5,"TaskName":"Construct Bin","StartDate":"2025-10-25T15:00:00.000Z","EndDate":"2025-10-28T00:00:00.000Z","Duration":3,"Predecessor":"4FS-1 days","resources":[{"resourceId":"Guanghan","resourceName":"Guanghan","unit":100},{"resourceId":"Isaac","resourceName":"Isaac","unit":100},{"resourceId":"John","resourceName":"John","unit":100},{"resourceId":"Renee","resourceName":"Renee","unit":100}],"Progress":0,"color":"211","info":"<p><br></p>","DurationUnit":"day"},{"TaskID":6,"TaskName":"Assemble Bin","StartDate":"2025-10-27T15:00:00.000Z","EndDate":"2025-10-31T00:00:00.000Z","Duration":4,"Predecessor":"5FS-1 days","resources":[{"resourceId":"Guanghan","resourceName":"Guanghan","unit":100},{"resourceId":"Isaac","resourceName":"Isaac","unit":100},{"resourceId":"John","resourceName":"John","unit":100},{"resourceId":"Renee","resourceName":"Renee","unit":100}],"Progress":0,"color":"211","info":"<p><br></p>","DurationUnit":"day"},{"TaskID":7,"TaskName":"Construct Cup","StartDate":"2025-10-24T15:00:00.000Z","EndDate":"2025-10-28T00:00:00.000Z","Duration":4,"Predecessor":"","resources":[{"resourceId":"Guanghan","resourceName":"Guanghan","unit":100}],"Progress":0,"color":"121","info":"<p><br></p>","DurationUnit":"day"},{"TaskID":8,"TaskName":"Assemble Cup","StartDate":"2025-10-27T15:00:00.000Z","EndDate":"2025-10-31T00:00:00.000Z","Duration":4,"Predecessor":"7FS-1 days","resources":[{"resourceId":"Guanghan","resourceName":"Guanghan","unit":100},{"resourceId":"Isaac","resourceName":"Isaac","unit":100},{"resourceId":"John","resourceName":"John","unit":100},{"resourceId":"Renee","resourceName":"Renee","unit":100}],"Progress":0,"color":"121","info":"<p><br></p>","DurationUnit":"day"},{"TaskID":9,"TaskName":"Measure Success","StartDate":"2025-10-31T15:00:00.000Z","EndDate":"2025-11-15T01:00:00.000Z","Duration":15,"Predecessor":"6FS,8FS","resources":[{"resourceId":"Guanghan","resourceName":"Guanghan","unit":100},{"resourceId":"Isaac","resourceName":"Isaac","unit":100},{"resourceId":"John","resourceName":"John","unit":100},{"resourceId":"Renee","resourceName":"Renee","unit":100}],"Progress":0,"color":"211","info":"<p><br></p>","DurationUnit":"day"},{"TaskID":10,"TaskName":"Design Second Iteration Ideas","StartDate":"2025-11-14T16:00:00.000Z","EndDate":"2025-11-20T01:00:00.000Z","Duration":6,"Predecessor":"9FS-1 days","resources":[{"resourceId":"Guanghan","resourceName":"Guanghan","unit":100},{"resourceId":"Isaac","resourceName":"Isaac","unit":100},{"resourceId":"John","resourceName":"John","unit":100},{"resourceId":"Renee","resourceName":"Renee","unit":100}],"Progress":0,"color":"211","info":"<p><br></p>","DurationUnit":"day"},{"TaskID":11,"TaskName":"Second Iteration Implementation","StartDate":"2025-11-19T16:00:00.000Z","EndDate":"2025-11-27T01:00:00.000Z","Duration":8,"Predecessor":"10FS-1 days","resources":[{"resourceId":"Guanghan","resourceName":"Guanghan","unit":100},{"resourceId":"Isaac","resourceName":"Isaac","unit":100},{"resourceId":"John","resourceName":"John","unit":100},{"resourceId":"Renee","resourceName":"Renee","unit":100}],"Progress":0,"color":"211","info":"<p><br></p>","DurationUnit":"day"},{"TaskID":12,"TaskName":"Final Presentation and Deliverables","StartDate":"2025-10-31T15:00:00.000Z","EndDate":"2025-12-04T01:00:00.000Z","Duration":34,"Predecessor":"","resources":[{"resourceId":"Guanghan","resourceName":"Guanghan","unit":100},{"resourceId":"Isaac","resourceName":"Isaac","unit":100},{"resourceId":"John","resourceName":"John","unit":100},{"resourceId":"Renee","resourceName":"Renee","unit":100}],"Progress":0,"color":"211","info":"<p><br></p>","DurationUnit":"day"}]}],"resources":[{"resourceId":"Guanghan","resourceName":"Guanghan"},{"resourceId":"Isaac","resourceName":"Isaac"},{"resourceId":"John","resourceName":"John"},{"resourceId":"Renee","resourceName":"Renee"}],"projectStartDate":null,"projectEndDate":null,"advanced":{"columns":[{"name":"Task ID","width":"70","show":true},{"name":"Task Name","width":"350","show":true},{"name":"Start Date","width":"130","show":false},{"name":"End Date","width":"130","show":false},{"name":"Duration","width":"130","show":false},{"name":"Progress %","width":"150","show":false},{"name":"Dependency","width":"150","show":false},{"name":"Resources","width":"200","show":false},{"name":"Color","width":"100","show":false}],"zoomLevel":0,"timezone":"America/Los_Angeles","timezoneOffset":420,"dependencyConflict":"Add Offset to Dependency","dateFormat":"yyyy-MM-dd","timeFormat":"HH:mm","firstDayOfWeek":0,"workWeek":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],"workTime":[{"from":8,"to":12},{"from":13,"to":17}],"holidays":[]}};

    document.addEventListener("DOMContentLoaded", () => {
      (async () => {
        let dataset = embeddedDataset;
        try {
          const loaded = await loadDatasetFromFile("./BSF.gantt");
          if (loaded) {
            dataset = loaded;
          }
        } catch (error) {
          console.warn("Falling back to embedded dataset:", error);
        }
        initializeChart(dataset || embeddedDataset);
      })();
    });

    async function loadDatasetFromFile(path) {
      try {
        const response = await fetch(path, { cache: "no-store" });
        if (!response.ok) {
          throw new Error(`Failed to fetch dataset (${response.status})`);
        }
        const rawText = await response.text();
        const cleaned = sanitizeJson(rawText);
        return JSON.parse(cleaned);
      } catch (error) {
        console.error("Unable to load dataset", error);
        throw error;
      }
    }

    function sanitizeJson(text) {
      if (!text) {
        return text;
      }
      const trimmed = text.trim();
      const first = trimmed.search(/[\[{]/);
      if (first === -1) {
        return trimmed;
      }
      return trimmed.slice(first);
    }

    function initializeChart(rawDataset) {
      const dataset = {
        ...rawDataset,
        data: Array.isArray(rawDataset?.data) ? rawDataset.data : [],
        resources: Array.isArray(rawDataset?.resources) ? rawDataset.resources : []
      };

      const elements = collectElements();
      if (!dataset.data.length || !dataset.data[0]) {
        renderEmptyState(elements, "No tasks available for this project.");
        return;
      }

      const advanced = dataset.advanced || {};
      const projectTimeZone = typeof advanced.timezone === "string" && advanced.timezone ? advanced.timezone : "UTC";
      const projectOffsetMinutes = Number.isFinite(advanced.timezoneOffset) ? advanced.timezoneOffset : 0;
      const projectOffsetMs = projectOffsetMinutes * 60 * 1000;
      const dayMs = 24 * 60 * 60 * 1000;
      const layout = {
        headerHeight: 54,
        rowHeight: 58,
        barHeight: 28
      };

      document.documentElement.style.setProperty("--header-height", `${layout.headerHeight}px`);
      document.documentElement.style.setProperty("--row-height", `${layout.rowHeight}px`);

      const toProjectMs = (value) => {
        if (value == null) {
          return null;
        }
        const utcMs = value instanceof Date ? value.getTime() : Date.parse(value);
        if (!Number.isFinite(utcMs)) {
          return null;
        }
        return utcMs - projectOffsetMs;
      };

      const fromProjectMs = (projectMs) => {
        if (projectMs == null) {
          return null;
        }
        return new Date(projectMs + projectOffsetMs);
      };

      const startOfProjectDayMs = (input) => {
        const projectMs = typeof input === "number" ? input : toProjectMs(input);
        if (!Number.isFinite(projectMs)) {
          return null;
        }
        return Math.floor(projectMs / dayMs) * dayMs;
      };

      const addProjectDays = (projectMs, days) => projectMs + days * dayMs;

      const toInputDate = (projectMs) => {
        if (!Number.isFinite(projectMs)) {
          return "";
        }
        const formatter = new Intl.DateTimeFormat("en-CA", {
          timeZone: projectTimeZone,
          year: "numeric",
          month: "2-digit",
          day: "2-digit"
        });
        return formatter.format(fromProjectMs(projectMs));
      };

      const fromInputDate = (value) => {
        if (!value) {
          return null;
        }
        const [year, month, day] = value.split("-").map(Number);
        if (![year, month, day].every((part) => Number.isFinite(part))) {
          return null;
        }
        return Date.UTC(year, (month || 1) - 1, day || 1);
      };

      const formatProjectDate = (value, options = {}) => {
        if (!value) {
          return "";
        }
        const date = value instanceof Date ? value : new Date(value);
        const formatter = new Intl.DateTimeFormat(undefined, {
          timeZone: projectTimeZone,
          ...options
        });
        return formatter.format(date);
      };

      const formatRange = (startProjectMs, endProjectMs) => {
        const startDate = fromProjectMs(startProjectMs);
        const endDate = fromProjectMs(endProjectMs);
        if (!startDate || !endDate) {
          return "";
        }
        const rangeOptions = { month: "short", day: "numeric" };
        const startYear = formatProjectDate(startDate, { year: "numeric" });
        const endYear = formatProjectDate(endDate, { year: "numeric" });
        if (startYear === endYear) {
          return `${formatProjectDate(startDate, rangeOptions)} – ${formatProjectDate(endDate, rangeOptions)} ${startYear}`;
        }
        return `${formatProjectDate(startDate, { month: "short", day: "numeric", year: "numeric" })} – ${formatProjectDate(endDate, { month: "short", day: "numeric", year: "numeric" })}`;
      };

      const parseDependencies = (raw) => {
        if (!raw) {
          return [];
        }
        return raw.split(",").map((part) => {
          const trimmed = part.trim();
          if (!trimmed) {
            return null;
          }
          const match = trimmed.match(/^(\d+)([A-Z]{2})(.*)?$/);
          if (!match) {
            return null;
          }
          const [, id, type, remainder] = match;
          const offsetMatch = remainder ? remainder.match(/([+-]\d+)\s*days?/i) : null;
          const offset = offsetMatch ? parseInt(offsetMatch[1], 10) : 0;
          return {
            id: Number(id),
            type,
            offset
          };
        }).filter(Boolean);
      };

      const flattenedTasks = [];
      const taskIndex = new Map();

      (function flatten(task, level = 0) {
        if (!task) {
          return;
        }
        const startProjectMs = toProjectMs(task.StartDate);
        const endProjectMs = toProjectMs(task.EndDate);
        const durationDays = typeof task.Duration === "number" && task.Duration > 0
          ? task.Duration
          : Math.max(1, Math.round(((endProjectMs ?? 0) - (startProjectMs ?? 0)) / dayMs));

        const normalized = {
          ...task,
          level,
          startProjectMs,
          endProjectMs,
          startDate: fromProjectMs(startProjectMs),
          endDate: fromProjectMs(endProjectMs),
          startDayMs: startOfProjectDayMs(startProjectMs),
          endDayMs: startOfProjectDayMs(endProjectMs),
          durationDays: Math.max(1, durationDays),
          progress: typeof task.Progress === "number" ? task.Progress : 0,
          dependencies: parseDependencies(task.Predecessor),
          resourceNames: Array.isArray(task.resources)
            ? task.resources.map((res) => res.resourceName || res.resourceId).filter(Boolean)
            : []
        };

        flattenedTasks.push(normalized);
        taskIndex.set(normalized.TaskID, normalized);

        (Array.isArray(task.subtasks) ? task.subtasks : []).forEach((child) => flatten(child, level + 1));
      })(dataset.data[0], 0);

      const validTasks = flattenedTasks.filter((task) => Number.isFinite(task.startProjectMs) && Number.isFinite(task.endProjectMs));
      if (!validTasks.length) {
        renderEmptyState(elements, "Tasks are missing schedule information.");
        return;
      }

      const projectStartDayMs = validTasks.reduce((min, task) => Math.min(min, task.startDayMs ?? Infinity), Infinity);
      const projectEndBoundaryMs = validTasks.reduce((max, task) => {
        const endBoundary = addProjectDays(task.endDayMs ?? task.endProjectMs ?? 0, 1);
        return Math.max(max, endBoundary);
      }, -Infinity);
      const totalDays = Math.max(1, Math.ceil((projectEndBoundaryMs - projectStartDayMs) / dayMs));

      const resourcesPalette = {
        Guanghan: "#4c9aff",
        Isaac: "#ff9f43",
        John: "#ff6b81",
        Renee: "#54d1db"
      };

      const colorMap = {
        "211": "#3a7bd5",
        "121": "#2fa784",
        "301": "#8c77f0"
      };

      const categoryLabels = {
        "301": "Program Oversight",
        "211": "Structure & Iteration",
        "121": "Feeder Cup"
      };

      const state = {
        defaultDayWidth: parseInt(elements.zoomControl?.value ?? "30", 10) || 30,
        dayWidth: parseInt(elements.zoomControl?.value ?? "30", 10) || 30,
        pinnedTaskId: null
      };

      const labelRows = new Map();
      const taskBars = new Map();
      const barPositions = new Map();

      initLegends(dataset.resources);
      renderSummary();
      renderWorkload();
      initControls();
      renderChart();
      updateDetails(flattenedTasks[0]);
      scrollToProjectDay(projectStartDayMs);

      function collectElements() {
        return {
          teamLegend: document.getElementById("teamLegend"),
          categoryLegend: document.getElementById("categoryLegend"),
          metricTasks: document.getElementById("metricTasks"),
          metricProgress: document.getElementById("metricProgress"),
          metricRemaining: document.getElementById("metricRemaining"),
          metricResources: document.getElementById("metricResources"),
          glanceDuration: document.getElementById("glanceDuration"),
          glanceDependencies: document.getElementById("glanceDependencies"),
          glanceWeeks: document.getElementById("glanceWeeks"),
          projectDateRange: document.getElementById("projectDateRange"),
          projectStart: document.getElementById("projectStart"),
          projectEnd: document.getElementById("projectEnd"),
          labelColumn: document.getElementById("labelColumn"),
          timelineHeader: document.getElementById("timelineHeader"),
          tasksLayer: document.getElementById("tasksLayer"),
          ganttGrid: document.getElementById("ganttGrid"),
          dependencyLayer: document.getElementById("dependencyLayer"),
          milestoneLayer: document.getElementById("milestoneLayer"),
          todayLine: document.getElementById("todayLine"),
          zoomControl: document.getElementById("zoomControl"),
          dateNavigator: document.getElementById("dateNavigator"),
          resetView: document.getElementById("resetView"),
          chartScroller: document.querySelector(".chart-scroller"),
          chartArea: document.querySelector(".chart-area"),
          legendCard: document.querySelectorAll(".legend-card"),
          detailsPanel: document.getElementById("detailsPanel"),
          detailsTitle: document.getElementById("detailsTitle"),
          detailsSubtitle: document.getElementById("detailsSubtitle"),
          detailDates: document.getElementById("detailDates"),
          detailProgress: document.getElementById("detailProgress"),
          detailResources: document.getElementById("detailResources"),
          detailDependencies: document.getElementById("detailDependencies"),
          resourceWorkload: document.getElementById("resourceWorkload")
        };
      }

      function renderEmptyState(el, message) {
        if (el.chartArea) {
          el.chartArea.innerHTML = `<div class="empty-state">${message}</div>`;
        }
        if (el.labelColumn) {
          el.labelColumn.innerHTML = "";
        }
        if (el.timelineHeader) {
          el.timelineHeader.innerHTML = "";
        }
        if (el.tasksLayer) {
          el.tasksLayer.innerHTML = "";
        }
        if (el.dependencyLayer) {
          el.dependencyLayer.innerHTML = "";
        }
        if (el.milestoneLayer) {
          el.milestoneLayer.innerHTML = "";
        }
        if (el.todayLine) {
          el.todayLine.style.display = "none";
        }
        if (el.detailsTitle) {
          el.detailsTitle.textContent = "No task selected";
        }
        if (el.detailsSubtitle) {
          el.detailsSubtitle.textContent = message;
        }
        if (el.detailDates) {
          el.detailDates.textContent = "—";
        }
        if (el.detailProgress) {
          el.detailProgress.textContent = "—";
        }
        if (el.detailResources) {
          el.detailResources.textContent = "—";
        }
        if (el.detailDependencies) {
          el.detailDependencies.textContent = "—";
        }
        if (el.resourceWorkload) {
          el.resourceWorkload.innerHTML = "";
        }
      }

      function initLegends(resources) {
        elements.teamLegend.innerHTML = "";
        resources.forEach((resource) => {
          const legendItem = document.createElement("div");
          legendItem.className = "legend-item";

          const avatar = document.createElement("span");
          avatar.className = "legend-avatar";
          avatar.textContent = (resource.resourceName || "?").charAt(0);
          avatar.style.background = resourcesPalette[resource.resourceName] || "#7c8db5";

          const info = document.createElement("div");
          info.className = "legend-info";
          info.innerHTML = `<span>${resource.resourceName || resource.resourceId}</span><span>Contributor</span>`;

          legendItem.append(avatar, info);
          elements.teamLegend.appendChild(legendItem);
        });

        elements.categoryLegend.innerHTML = "";
        Object.entries(categoryLabels).forEach(([key, label]) => {
          const legendItem = document.createElement("div");
          legendItem.className = "legend-item";

          const swatch = document.createElement("span");
          swatch.className = "legend-swatch";
          swatch.style.background = colorMap[key] || "#94a3b8";

          const info = document.createElement("div");
          info.className = "legend-info";
          info.innerHTML = `<span>${label}</span><span>Color ${key}</span>`;

          legendItem.append(swatch, info);
          elements.categoryLegend.appendChild(legendItem);
        });
      }

      function renderSummary() {
        const subtasks = flattenedTasks.filter((task) => task.level > 0);
        const avgProgress = subtasks.length
          ? Math.round(subtasks.reduce((sum, task) => sum + (task.progress || 0), 0) / subtasks.length)
          : 0;
        const todayProjectDayMs = startOfProjectDayMs(Date.now());
        let remaining;
        if (todayProjectDayMs < projectStartDayMs) {
          remaining = `${Math.ceil((projectStartDayMs - todayProjectDayMs) / dayMs)} days to kickoff`;
        } else if (todayProjectDayMs >= projectEndBoundaryMs) {
          remaining = "Complete";
        } else {
          remaining = `${Math.max(0, Math.ceil((projectEndBoundaryMs - todayProjectDayMs) / dayMs))} days remaining`;
        }

        elements.metricTasks.textContent = flattenedTasks.length;
        elements.metricProgress.textContent = `${Number.isFinite(avgProgress) ? avgProgress : 0}%`;
        elements.metricRemaining.textContent = remaining;
        elements.metricResources.textContent = `${dataset.resources.length}`;

        const dependenciesCount = flattenedTasks.reduce((total, task) => total + task.dependencies.length, 0);
        const rootTask = flattenedTasks.find((task) => task.level === 0);
        elements.glanceDuration.textContent = rootTask?.Duration ? `${rootTask.Duration} days` : `${totalDays} days`;
        elements.glanceDependencies.textContent = dependenciesCount;
        elements.glanceWeeks.textContent = `${Math.ceil(totalDays / 7)} weeks`;

        const endDisplayMs = addProjectDays(projectEndBoundaryMs, -1);
        elements.projectDateRange.textContent = formatRange(projectStartDayMs, endDisplayMs);
        elements.projectStart.textContent = formatProjectDate(fromProjectMs(projectStartDayMs), {
          month: "short",
          day: "numeric",
          year: "numeric"
        });
        elements.projectEnd.textContent = formatProjectDate(fromProjectMs(endDisplayMs), {
          month: "short",
          day: "numeric",
          year: "numeric"
        });
      }

      function renderWorkload() {
        const workload = new Map();
        flattenedTasks.forEach((task) => {
          (Array.isArray(task.resources) ? task.resources : []).forEach((assignment) => {
            const name = assignment.resourceName || assignment.resourceId;
            if (!name) {
              return;
            }
            const portion = Number.isFinite(assignment.unit) ? assignment.unit / 100 : 1;
            workload.set(name, (workload.get(name) || 0) + task.durationDays * portion);
          });
        });

        elements.resourceWorkload.innerHTML = "";
        if (workload.size === 0) {
          const empty = document.createElement("p");
          empty.textContent = "No resource assignments yet.";
          empty.style.color = "var(--muted)";
          empty.style.fontSize = "0.85rem";
          elements.resourceWorkload.appendChild(empty);
          return;
        }

        const maxLoad = Math.max(...workload.values());
        workload.forEach((value, name) => {
          const row = document.createElement("div");
          row.className = "workload-row";

          const label = document.createElement("span");
          label.className = "workload-label";
          label.textContent = name;

          const bar = document.createElement("div");
          bar.className = "workload-bar";

          const fill = document.createElement("div");
          fill.className = "workload-fill";
          fill.style.width = `${(value / maxLoad) * 100}%`;
          fill.style.background = resourcesPalette[name] || "#7c8db5";

          const valueEl = document.createElement("span");
          valueEl.className = "workload-value";
          valueEl.textContent = `${value.toFixed(1)} d`;

          bar.appendChild(fill);
          row.append(label, bar, valueEl);
          elements.resourceWorkload.appendChild(row);
        });
      }

      function setHoverState(taskId, isHovering) {
        const labelRow = labelRows.get(taskId);
        const bar = taskBars.get(taskId);
        if (labelRow) {
          labelRow.classList.toggle("hovered", Boolean(isHovering));
        }
        if (bar) {
          bar.classList.toggle("is-hover", Boolean(isHovering));
        }
      }

      function setPinnedState(taskId) {
        labelRows.forEach((row, id) => {
          row.classList.toggle("active", id === taskId);
        });
        taskBars.forEach((bar, id) => {
          bar.classList.toggle("is-active", id === taskId);
          bar.classList.toggle("is-pinned", id === taskId);
        });
      }

      function updateDetails(task) {
        if (!task) {
          return;
        }
        const durationLabel = `${task.durationDays} day${task.durationDays !== 1 ? "s" : ""}`;
        elements.detailsTitle.textContent = task.TaskName;
        elements.detailsSubtitle.textContent = `Task ${task.TaskID} • ${durationLabel}`;
        elements.detailDates.textContent = `${formatProjectDate(task.startDate, {
          month: "short",
          day: "numeric",
          year: "numeric"
        })} → ${formatProjectDate(task.endDate, {
          month: "short",
          day: "numeric",
          year: "numeric"
        })}`;
        elements.detailProgress.textContent = `${Math.round(task.progress)}% complete`;
        elements.detailResources.textContent = task.resourceNames.length ? task.resourceNames.join(", ") : "Unassigned";
        elements.detailDependencies.textContent = task.dependencies.length
          ? task.dependencies.map((dep) => {
            const offsetLabel = dep.offset ? ` (${dep.offset > 0 ? "+" : ""}${dep.offset}d)` : "";
            return `#${dep.id} ${dep.type}${offsetLabel}`;
          }).join(", ")
          : "None";
      }

      function renderChart() {
        barPositions.clear();
        labelRows.clear();
        taskBars.clear();

        const chartWidth = totalDays * state.dayWidth;
        const chartHeight = layout.headerHeight + flattenedTasks.length * layout.rowHeight;

        elements.chartArea.style.width = `${chartWidth}px`;
        elements.chartArea.style.height = `${chartHeight}px`;
        elements.chartArea.style.setProperty("--day-width", `${state.dayWidth}px`);
        elements.ganttGrid.style.setProperty("--day-width", `${state.dayWidth}px`);

        renderTimelineHeader();
        renderLabels();
        renderTasks();
        renderMilestones();
        drawDependencies();
        renderTodayLine();

        if (state.pinnedTaskId !== null) {
          const pinnedTask = taskIndex.get(state.pinnedTaskId);
          if (pinnedTask) {
            setPinnedState(pinnedTask.TaskID);
            updateDetails(pinnedTask);
          }
        } else {
          setPinnedState(null);
        }
      }

      function renderTimelineHeader() {
        elements.timelineHeader.innerHTML = "";
        const headerFragment = document.createDocumentFragment();
        for (let i = 0; i < totalDays; i += 1) {
          const currentProjectMs = addProjectDays(projectStartDayMs, i);
          const currentDate = fromProjectMs(currentProjectMs);
          if (!currentDate) {
            continue;
          }
          const dayOfWeek = currentDate.getUTCDay();
          const dateNumber = Number(new Intl.DateTimeFormat("en-US", { timeZone: projectTimeZone, day: "numeric" }).format(currentDate));
          if (dayOfWeek === 1 || dateNumber === 1 || i === 0) {
            const label = document.createElement("div");
            label.className = "timeline-label";
            label.style.left = `${i * state.dayWidth}px`;
            label.textContent = formatProjectDate(currentDate, { month: "short", day: "numeric" });
            headerFragment.appendChild(label);
          }
        }
        elements.timelineHeader.appendChild(headerFragment);
      }

      function renderLabels() {
        elements.labelColumn.innerHTML = "";
        const fragment = document.createDocumentFragment();
        flattenedTasks.forEach((task) => {
          const row = document.createElement("div");
          row.className = "label-row";
          if (task.level === 0) {
            row.classList.add("is-parent");
          }
          row.dataset.taskId = String(task.TaskID);

          const index = document.createElement("span");
          index.className = "label-index";
          index.textContent = String(task.TaskID).padStart(2, "0");

          const name = document.createElement("span");
          name.className = "label-name";
          name.style.paddingLeft = `${task.level * 18}px`;
          name.textContent = task.TaskName;

          const duration = document.createElement("span");
          duration.className = "label-duration";
          duration.textContent = `${task.durationDays} d`;

          row.append(index, name, duration);
          fragment.appendChild(row);
          labelRows.set(task.TaskID, row);
        });
        elements.labelColumn.appendChild(fragment);
      }

      function renderTasks() {
        elements.tasksLayer.innerHTML = "";
        const fragment = document.createDocumentFragment();

        flattenedTasks.forEach((task, index) => {
          const rowOffset = layout.headerHeight + index * layout.rowHeight;
          const barLeft = ((task.startDayMs ?? projectStartDayMs) - projectStartDayMs) / dayMs * state.dayWidth;
          const barWidth = Math.max(task.durationDays * state.dayWidth, state.dayWidth * 0.6);
          const barTop = rowOffset + (layout.rowHeight - layout.barHeight) / 2;

          const bar = document.createElement("div");
          bar.className = "task-bar";
          bar.style.left = `${barLeft}px`;
          bar.style.top = `${barTop}px`;
          bar.style.width = `${barWidth}px`;
          bar.style.background = colorMap[String(task.color)] || "#7c8db5";
          bar.dataset.taskId = String(task.TaskID);
          bar.style.animationDelay = `${index * 60}ms`;

          if (task.level === 0) {
            bar.classList.add("task-bar--group");
          }
          if (task.progress >= 100) {
            bar.classList.add("task-bar--complete");
          }
          if (task.progress === 0) {
            bar.classList.add("task-bar--idle");
          }

          const progressFill = document.createElement("div");
          progressFill.className = "progress-fill";
          progressFill.style.width = `${Math.min(Math.max(task.progress, 0), 100)}%`;
          bar.appendChild(progressFill);

          const content = document.createElement("div");
          content.className = "task-bar__content";
          content.innerHTML = `
            <span class="task-chip">#${task.TaskID}</span>
            <span class="task-title">${task.TaskName}</span>
            <span class="task-progress-label">${Math.round(task.progress)}%</span>
          `;
          bar.appendChild(content);

          if (task.resourceNames.length) {
            const badgeContainer = document.createElement("div");
            badgeContainer.className = "resource-badges";
            task.resourceNames.forEach((name) => {
              const badge = document.createElement("span");
              badge.className = "resource-badge";
              badge.textContent = name.charAt(0);
              badge.title = name;
              badge.style.background = resourcesPalette[name] || "#94a3b8";
              badgeContainer.appendChild(badge);
            });
            bar.appendChild(badgeContainer);
          }

          bar.addEventListener("mouseenter", () => {
            setHoverState(task.TaskID, true);
            if (state.pinnedTaskId === null || state.pinnedTaskId === task.TaskID) {
              updateDetails(task);
            }
          });

          bar.addEventListener("mouseleave", () => {
            setHoverState(task.TaskID, false);
            if (state.pinnedTaskId !== null) {
              const pinnedTask = taskIndex.get(state.pinnedTaskId);
              if (pinnedTask) {
                updateDetails(pinnedTask);
                setPinnedState(state.pinnedTaskId);
              }
            }
          });

          bar.addEventListener("click", () => {
            if (state.pinnedTaskId === task.TaskID) {
              state.pinnedTaskId = null;
              elements.detailsPanel.classList.remove("is-pinned");
              setPinnedState(null);
            } else {
              state.pinnedTaskId = task.TaskID;
              elements.detailsPanel.classList.add("is-pinned");
              updateDetails(task);
              setPinnedState(task.TaskID);
            }
          });

          barPositions.set(task.TaskID, {
            left: barLeft,
            right: barLeft + barWidth,
            top: barTop,
            centerY: barTop + layout.barHeight / 2
          });

          taskBars.set(task.TaskID, bar);
          fragment.appendChild(bar);
        });

        elements.tasksLayer.appendChild(fragment);
      }

      function createSvgElement(tag, attributes = {}) {
        const element = document.createElementNS("http://www.w3.org/2000/svg", tag);
        Object.entries(attributes).forEach(([key, value]) => {
          element.setAttribute(key, value);
        });
        return element;
      }

      function drawDependencies() {
        const width = totalDays * state.dayWidth;
        const height = layout.headerHeight + flattenedTasks.length * layout.rowHeight;
        const svg = elements.dependencyLayer;
        svg.innerHTML = "";
        svg.setAttribute("width", width);
        svg.setAttribute("height", height);

        const dependencyStyles = {
          FS: { stroke: "rgba(50, 64, 89, 0.6)", dash: "" },
          SS: { stroke: "rgba(47, 167, 132, 0.7)", dash: "6 4" },
          FF: { stroke: "rgba(140, 119, 240, 0.75)", dash: "4 5" },
          SF: { stroke: "rgba(255, 99, 132, 0.7)", dash: "2 3" }
        };

        const defs = createSvgElement("defs");
        Object.entries(dependencyStyles).forEach(([type, style]) => {
          const markerId = `arrowhead-${type.toLowerCase()}`;
          const marker = createSvgElement("marker", {
            id: markerId,
            viewBox: "0 0 10 10",
            refX: "9",
            refY: "5",
            markerWidth: "7",
            markerHeight: "7",
            orient: "auto"
          });
          const markerPath = createSvgElement("path", {
            d: "M 0 0 L 10 5 L 0 10 z",
            fill: style.stroke
          });
          marker.appendChild(markerPath);
          defs.appendChild(marker);
        });
        svg.appendChild(defs);

        flattenedTasks.forEach((task) => {
          task.dependencies.forEach((dep) => {
            const predecessorPosition = barPositions.get(dep.id);
            const successorPosition = barPositions.get(task.TaskID);
            if (!predecessorPosition || !successorPosition) {
              return;
            }

            const style = dependencyStyles[dep.type] || dependencyStyles.FS;
            const markerId = `arrowhead-${(dep.type || "FS").toLowerCase()}`;
            const offsetPx = (dep.offset || 0) * state.dayWidth;

            let startX = predecessorPosition.right;
            let endX = successorPosition.left + offsetPx;

            if (dep.type === "SS") {
              startX = predecessorPosition.left;
              endX = successorPosition.left + offsetPx;
            } else if (dep.type === "FF") {
              startX = predecessorPosition.right;
              endX = successorPosition.right + offsetPx;
            } else if (dep.type === "SF") {
              startX = predecessorPosition.right;
              endX = successorPosition.left + offsetPx;
            }

            const startY = predecessorPosition.centerY;
            const endY = successorPosition.centerY;
            const horizontalGap = endX - startX;
            const controlOffset = horizontalGap >= 0
              ? Math.max(40, horizontalGap / 2)
              : Math.max(40, Math.abs(horizontalGap) / 2);
            const controlX1 = horizontalGap >= 0 ? startX + controlOffset : startX + 20;
            const controlX2 = horizontalGap >= 0 ? endX - controlOffset : endX - 20;
            const path = createSvgElement("path", {
              d: `M ${startX} ${startY} C ${controlX1} ${startY}, ${controlX2} ${endY}, ${endX} ${endY}`,
              "marker-end": `url(#${markerId})`
            });
            path.setAttribute("stroke", style.stroke);
            path.setAttribute("fill", "none");
            path.setAttribute("stroke-width", dep.type === "FF" ? "2.5" : "2");
            if (style.dash) {
              path.setAttribute("stroke-dasharray", style.dash);
            }
            svg.appendChild(path);

            if (dep.offset) {
              const labelX = startX + (endX - startX) / 2;
              const labelY = startY + (endY - startY) / 2 - 8;
              const offsetLabel = createSvgElement("text", {
                x: labelX,
                y: labelY,
                class: "dependency-offset"
              });
              offsetLabel.textContent = `${dep.offset > 0 ? "+" : ""}${dep.offset}d`;
              svg.appendChild(offsetLabel);
            }
          });
        });
      }

      function renderMilestones() {
        elements.milestoneLayer.innerHTML = "";
        const milestoneCandidates = flattenedTasks.filter((task) => task.TaskID === 12 || task.isMilestone);
        milestoneCandidates.forEach((task) => {
          const position = barPositions.get(task.TaskID);
          if (!position) {
            return;
          }

          const marker = document.createElement("div");
          marker.className = "milestone";
          marker.style.left = `${position.right}px`;
          marker.style.top = `${position.centerY}px`;
          marker.title = `${task.TaskName} • ${formatProjectDate(task.endDate, {
            month: "short",
            day: "numeric",
            year: "numeric"
          })}`;

          const label = document.createElement("div");
          label.className = "milestone-label";
          label.textContent = task.TaskName;
          label.style.left = `${position.right}px`;
          label.style.top = `${position.centerY + 14}px`;

          elements.milestoneLayer.append(marker, label);
        });
      }

      function renderTodayLine() {
        const todayProjectDayMs = startOfProjectDayMs(Date.now());
        const visible = todayProjectDayMs >= projectStartDayMs && todayProjectDayMs < projectEndBoundaryMs;
        elements.todayLine.style.display = visible ? "block" : "none";
        if (visible) {
          const offsetDays = (todayProjectDayMs - projectStartDayMs) / dayMs;
          elements.todayLine.style.left = `${offsetDays * state.dayWidth}px`;
        }
      }

      function scrollToProjectDay(projectDayMs) {
        if (!Number.isFinite(projectDayMs)) {
          return;
        }
        const clamped = Math.max(projectStartDayMs, Math.min(projectDayMs, projectEndBoundaryMs - dayMs));
        const offsetDays = (clamped - projectStartDayMs) / dayMs;
        const targetLeft = Math.max(offsetDays * state.dayWidth - 120, 0);
        elements.chartScroller.scrollTo({
          left: targetLeft,
          behavior: "smooth"
        });
      }

      function initControls() {
        elements.zoomControl.addEventListener("input", (event) => {
          state.dayWidth = parseInt(event.target.value, 10) || state.defaultDayWidth;
          renderChart();
        });

        elements.dateNavigator.min = toInputDate(projectStartDayMs);
        elements.dateNavigator.max = toInputDate(addProjectDays(projectEndBoundaryMs, -1));
        elements.dateNavigator.value = toInputDate(projectStartDayMs);
        elements.dateNavigator.addEventListener("change", (event) => {
          const selected = fromInputDate(event.target.value);
          if (selected != null) {
            scrollToProjectDay(selected);
          }
        });

        elements.resetView.addEventListener("click", () => {
          state.dayWidth = state.defaultDayWidth;
          elements.zoomControl.value = state.defaultDayWidth;
          renderChart();
          scrollToProjectDay(projectStartDayMs);
          state.pinnedTaskId = null;
          elements.detailsPanel.classList.remove("is-pinned");
          setPinnedState(null);
          updateDetails(flattenedTasks[0]);
        });

        setupDragScroll();
      }

      function setupDragScroll() {
        const scroller = elements.chartScroller;
        if (!scroller) {
          return;
        }
        let isDragging = false;
        let startX = 0;
        let initialScrollLeft = 0;

        scroller.addEventListener("pointerdown", (event) => {
          if (event.button !== 0) {
            return;
          }
          isDragging = true;
          startX = event.clientX;
          initialScrollLeft = scroller.scrollLeft;
          scroller.classList.add("is-dragging");
          scroller.setPointerCapture?.(event.pointerId);
        });

        scroller.addEventListener("pointermove", (event) => {
          if (!isDragging) {
            return;
          }
          const deltaX = event.clientX - startX;
          scroller.scrollLeft = initialScrollLeft - deltaX;
        }, { passive: true });

        const endDrag = (event) => {
          if (!isDragging) {
            return;
          }
          isDragging = false;
          scroller.classList.remove("is-dragging");
          if (scroller.hasPointerCapture?.(event.pointerId)) {
            scroller.releasePointerCapture(event.pointerId);
          }
        };

        scroller.addEventListener("pointerup", endDrag);
        scroller.addEventListener("pointercancel", endDrag);
        scroller.addEventListener("pointerleave", endDrag);
      }

      let resizeTimeout = null;
      window.addEventListener("resize", () => {
        window.clearTimeout(resizeTimeout);
        resizeTimeout = window.setTimeout(() => {
          renderChart();
        }, 120);
      });
    }

  </script>
</body>
</html>
